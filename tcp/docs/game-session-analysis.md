# 오목 게임 세션 전체 흐름 정리

## 1. 매칭 이후 세션이 생성되는 과정
- 매칭 서버가 `MatchGroup`을 확정하면 `GameSessionCreationService.createFromGroup`에서 유저 ID를 추출해 `GameSession` 인스턴스를 생성하고 규칙 컨텍스트를 초기화한 뒤 저장소와 런타임에 등록한다 (`src/main/java/teamnova/omok/glue/game/session/services/GameSessionCreationService.java:20`, `src/main/java/teamnova/omok/glue/game/session/services/GameSessionCreationService.java:31`, `src/main/java/teamnova/omok/glue/game/session/services/GameSessionCreationService.java:33`).
- 생성된 세션은 인메모리 저장소 `InMemoryGameSessionRepository`에 보관되고 각 사용자 ID와 세션 ID가 빠르게 조회되도록 매핑된다 (`src/main/java/teamnova/omok/glue/game/session/repository/InMemoryGameSessionRepository.java:19`, `src/main/java/teamnova/omok/glue/game/session/repository/InMemoryGameSessionRepository.java:33`, `src/main/java/teamnova/omok/glue/game/session/repository/InMemoryGameSessionRepository.java:43`).
- 동시에 `GameStateHubRegistry.ensure`가 호출되어 상태 머신 허브가 생성되며, 이 허브는 이후 틱 루프에서 주기적으로 `process`를 실행해 상태 전이를 평가한다 (`src/main/java/teamnova/omok/glue/game/session/repository/GameStateHubRegistry.java:37`, `src/main/java/teamnova/omok/glue/game/session/repository/GameStateHubRegistry.java:41`, `src/main/java/teamnova/omok/glue/game/session/repository/GameStateHubRegistry.java:62`).
- 클라이언트는 `ClientSessionManager`를 통해 메시지를 전송받는데, 세션 생성 시 `GameSessionMessagePublisher.broadcastJoin`이 호출되어 참여자 전원에게 세션 참가 알림이 전달된다 (`src/main/java/teamnova/omok/glue/game/session/services/GameSessionMessagePublisher.java:45`, `src/main/java/teamnova/omok/glue/client/session/ClientSessionManager.java:38`, `src/main/java/teamnova/omok/glue/client/session/services/ClientSessionDirectory.java:83`).

## 2. GameSession 내부 구조와 저장소
- `GameSession`은 생성자에서 라이프사이클, 보드, 턴, 결과 저장소를 구성하고 모든 조작을 보호하기 위해 `ReentrantLock`을 유지한다 (`src/main/java/teamnova/omok/glue/game/session/model/GameSession.java:38`, `src/main/java/teamnova/omok/glue/game/session/model/GameSession.java:44`, `src/main/java/teamnova/omok/glue/game/session/model/GameSession.java:36`).
- 참여자 정보는 `ParticipantsStore`에 보관되며 준비 상태와 연결 해제 상태를 비동기 환경에서도 안전하게 다룰 수 있도록 `ConcurrentHashMap` 기반으로 동작한다 (`src/main/java/teamnova/omok/glue/game/session/model/ParticipantsStore.java:18`, `src/main/java/teamnova/omok/glue/game/session/model/ParticipantsStore.java:55`, `src/main/java/teamnova/omok/glue/game/session/model/ParticipantsStore.java:68`).
- 턴 정보는 `TurnStore`가 순서, 카운터, 현재 플레이어 인덱스, 잔여 시간 정보를 나눠 저장하며 상태 머신이 순환하면서 값을 갱신한다 (`src/main/java/teamnova/omok/glue/game/session/model/TurnStore.java:13`, `src/main/java/teamnova/omok/glue/game/session/model/TurnStore.java:22`, `src/main/java/teamnova/omok/glue/game/session/model/TurnStore.java:50`).
- 결과와 재대결 의사는 각각 `OutcomeStore`와 `PostGameStore`에서 관리하며, 게임 종료 여부 판단 혹은 리매치 매칭 조건을 충족시키기 위한 데이터로 소비된다 (`src/main/java/teamnova/omok/glue/game/session/model/OutcomeStore.java:21`, `src/main/java/teamnova/omok/glue/game/session/model/OutcomeStore.java:45`, `src/main/java/teamnova/omok/glue/game/session/model/PostGameStore.java:16`, `src/main/java/teamnova/omok/glue/game/session/model/PostGameStore.java:43`).
- 보드 조작은 `BoardStore`의 1차원 배열을 통해 이루어지며, `GameSession`은 좌표를 선형 인덱스로 변환해 돌을 배치한다 (`src/main/java/teamnova/omok/glue/game/session/model/BoardStore.java:16`, `src/main/java/teamnova/omok/glue/game/session/model/GameSession.java:258`, `src/main/java/teamnova/omok/glue/game/session/model/GameSession.java:262`).

## 3. 상태 머신 구성과 전이 흐름
- `GameStateHub`는 모든 상태 구현체를 등록하고 초기 상태를 `LOBBY`로 지정하며, 상태 전이마다 `GameSessionStateType`을 기록한다 (`src/main/java/teamnova/omok/glue/game/session/states/GameStateHub.java:70`, `src/main/java/teamnova/omok/glue/game/session/states/GameStateHub.java:82`, `src/main/java/teamnova/omok/glue/game/session/states/GameStateHub.java:89`).
- 각 상태는 `GameSessionStateContext`를 통해 세션 데이터와 임시 버퍼에 접근하며, 버퍼는 이동/준비/타임아웃/결과 메시지를 큐잉하는 데 사용된다 (`src/main/java/teamnova/omok/glue/game/session/states/manage/GameSessionStateContext.java:30`, `src/main/java/teamnova/omok/glue/game/session/states/manage/GameSessionStateContext.java:98`, `src/main/java/teamnova/omok/glue/game/session/states/manage/GameSessionStateContext.java:170`).
- 준비 단계에서 `LobbyGameSessionState.handleReady`는 모든 플레이어가 준비되었는지 확인하고 최초 턴 스냅샷을 생성한 뒤 게임 시작 시각과 보드를 초기화한다 (`src/main/java/teamnova/omok/glue/game/session/states/state/LobbyGameSessionState.java:64`, `src/main/java/teamnova/omok/glue/game/session/states/state/LobbyGameSessionState.java:69`, `src/main/java/teamnova/omok/glue/game/session/states/state/LobbyGameSessionState.java:93`).
- `TurnWaitingState.handleMove`는 동시 요청을 방지하기 위해 세션에 락을 걸고 `TurnCycleContext`를 준비한 뒤 검증 단계로 전이한다 (`src/main/java/teamnova/omok/glue/game/session/states/state/TurnWaitingState.java:55`, `src/main/java/teamnova/omok/glue/game/session/states/state/TurnWaitingState.java:64`, `src/main/java/teamnova/omok/glue/game/session/states/manage/GameSessionTurnContextService.java:14`).
- `MoveValidatingState`는 플레이어 순서, 보드 범위, 빈 칸 여부 등을 점검하고 실패 시 즉시 대기 상태로 되돌아가며 `MoveResult.invalid`를 큐잉한다 (`src/main/java/teamnova/omok/glue/game/session/states/state/MoveValidatingState.java:95`, `src/main/java/teamnova/omok/glue/game/session/states/state/MoveValidatingState.java:108`, `src/main/java/teamnova/omok/glue/game/session/states/state/MoveValidatingState.java:137`).
- 검증이 통과하면 `MoveApplyingState`가 실제로 돌을 보드에 기록하고 결과 평가 단계로 넘긴다 (`src/main/java/teamnova/omok/glue/game/session/states/state/MoveApplyingState.java:37`, `src/main/java/teamnova/omok/glue/game/session/states/state/MoveApplyingState.java:42`).
- `OutcomeEvaluatingState`는 다섯 줄 달성 여부와 연결 해제 상태를 근거로 게임 종료를 판별하고, 승리 시 `MoveResult.success`와 `GameCompletionNotice`를 큐잉한다 (`src/main/java/teamnova/omok/glue/game/session/states/state/OutcomeEvaluatingState.java:69`, `src/main/java/teamnova/omok/glue/game/session/states/state/OutcomeEvaluatingState.java:104`, `src/main/java/teamnova/omok/glue/game/session/states/state/OutcomeEvaluatingState.java:205`).
- 게임이 지속되면 `TurnFinalizingState`가 다음 턴을 계산해 `TurnSnapshot`을 저장하고 큐에 성공 결과를 넣은 뒤 `TurnCycleContext`를 비운다 (`src/main/java/teamnova/omok/glue/game/session/states/state/TurnFinalizingState.java:43`, `src/main/java/teamnova/omok/glue/game/session/states/state/TurnFinalizingState.java:49`, `src/main/java/teamnova/omok/glue/game/session/states/manage/GameSessionTurnContextService.java:58`).
- `PostGameDecisionWaitingState`는 게임 종료 후 재대결/종료 의사를 수집하며, 지정된 기한이 지나면 자동으로 나머지를 기권 처리하고 다음 상태로 이동한다 (`src/main/java/teamnova/omok/glue/game/session/states/state/PostGameDecisionWaitingState.java:82`, `src/main/java/teamnova/omok/glue/game/session/states/state/PostGameDecisionWaitingState.java:137`, `src/main/java/teamnova/omok/glue/game/session/states/state/PostGameDecisionWaitingState.java:153`).

## 4. 이벤트 제출과 서비스 계층
- 외부에서 게임 세션과 상호작용하는 유일한 진입점은 `GameSessionManager`로, 싱글턴으로 초기화되어 클라이언트 핸들러가 이를 호출한다 (`src/main/java/teamnova/omok/glue/game/session/GameSessionManager.java:46`, `src/main/java/teamnova/omok/glue/game/session/GameSessionManager.java:135`, `src/main/java/teamnova/omok/glue/game/session/GameSessionManager.java:140`).
- `GameSessionManager`는 틱 스케줄러를 기동해 `GameSessionRuntime.tick`을 20ms 주기로 호출하고, 타임아웃 소비자 인터페이스를 구현해 스케줄러와 상태 머신 사이를 잇는다 (`src/main/java/teamnova/omok/glue/game/session/GameSessionManager.java:104`, `src/main/java/teamnova/omok/glue/game/session/GameSessionManager.java:182`, `src/main/java/teamnova/omok/glue/game/session/GameSessionManager.java:188`).
- 모든 이벤트는 `SessionEventService`를 거쳐 `GameStateHub`로 전달되며, 여기서 요청 시각과 상태 허브를 캡처한 `SessionSubmission`을 활용한다 (`src/main/java/teamnova/omok/glue/game/session/services/SessionEventService.java:40`, `src/main/java/teamnova/omok/glue/game/session/services/SessionEventService.java:59`, `src/main/java/teamnova/omok/glue/game/session/services/SessionEventService.java:106`).
- `ReadyEventProcessor`, `MoveEventProcessor`, `TimeoutEventProcessor`는 각각 큐잉된 컨텍스트 값을 소비하여 응답 메시지 전송, 타임아웃 스케줄링, 후속 상태 처리를 담당한다 (`src/main/java/teamnova/omok/glue/game/session/services/events/ReadyEventProcessor.java:25`, `src/main/java/teamnova/omok/glue/game/session/services/events/MoveEventProcessor.java:20`, `src/main/java/teamnova/omok/glue/game/session/services/events/TimeoutEventProcessor.java:23`).
- 제출된 이벤트 처리 후에는 공통적으로 `PostGameEventProcessor`를 통해 보조 효과(결과 방송, 재대결 프롬프트 등)를 마저 소화한다 (`src/main/java/teamnova/omok/glue/game/session/services/events/MoveEventProcessor.java:31`, `src/main/java/teamnova/omok/glue/game/session/services/events/ReadyEventProcessor.java:30`, `src/main/java/teamnova/omok/glue/game/session/services/events/TimeoutEventProcessor.java:28`).

## 5. 턴 타이머와 타임아웃 흐름
- `TurnService.start`는 첫 턴을 초기화할 때 플레이어 순서를 기록하고 타이밍을 설정하며, 이는 준비 이벤트가 모두 완료될 때 호출된다 (`src/main/java/teamnova/omok/glue/game/session/services/TurnService.java:35`, `src/main/java/teamnova/omok/glue/game/session/services/TurnService.java:41`, `src/main/java/teamnova/omok/glue/game/session/services/TurnService.java:43`).
- `TurnService.advanceSkippingDisconnected`는 연결이 끊긴 플레이어를 건너뛰고 다음 플레이어를 선택하며, 선택 결과는 `TurnSnapshot`으로 반환된다 (`src/main/java/teamnova/omok/glue/game/session/services/TurnService.java:47`, `src/main/java/teamnova/omok/glue/game/session/services/TurnService.java:52`, `src/main/java/teamnova/omok/glue/game/session/services/TurnService.java:63`).
- 실제 타이머는 `TurnTimeoutCoordinator.schedule`이 단일 스레드 스케줄러를 사용하여 등록하고, 만료 시 `TurnTimeoutConsumer.onTimeout`이 호출되어 상태 머신에 `TimeoutEvent`가 주입된다 (`src/main/java/teamnova/omok/glue/game/session/services/coordinator/TurnTimeoutCoordinator.java:32`, `src/main/java/teamnova/omok/glue/game/session/services/coordinator/TurnTimeoutCoordinator.java:44`, `src/main/java/teamnova/omok/glue/game/session/services/coordinator/TurnTimeoutCoordinator.java:51`).
- 스케줄된 타이머가 만료되면 `TimeoutEventProcessor.handleScheduledTimeout`이 세션을 찾아 상태 허브에 이벤트를 제출하고, 결과에 따라 후속 타이머를 재설정하거나 취소한다 (`src/main/java/teamnova/omok/glue/game/session/services/events/TimeoutEventProcessor.java:68`, `src/main/java/teamnova/omok/glue/game/session/services/events/TimeoutEventProcessor.java:81`, `src/main/java/teamnova/omok/glue/game/session/services/events/TimeoutEventProcessor.java:110`).
- 게임 중 연결이 끊긴 플레이어에 대해서는 `GameSessionLifecycleService.handleClientDisconnected`가 현재 턴을 확인해 필요시 즉시 타임아웃 이벤트를 스케줄한다 (`src/main/java/teamnova/omok/glue/game/session/services/GameSessionLifecycleService.java:53`, `src/main/java/teamnova/omok/glue/game/session/services/GameSessionLifecycleService.java:57`, `src/main/java/teamnova/omok/glue/game/session/services/GameSessionLifecycleService.java:68`).

## 6. TCP 프레임 포맷과 메시지 전달
- 모든 TCP 프레임은 4바이트 길이, 1바이트 타입, 4바이트 요청 ID, 가변 길이 페이로드 순으로 구성되며 최대 크기는 1MiB로 제한된다 (`src/main/java/teamnova/omok/core/nio/codec/FrameFormat.java:6`, `src/main/java/teamnova/omok/core/nio/codec/FrameFormat.java:11`, `src/main/java/teamnova/omok/core/nio/codec/FrameFormat.java:13`).
- 수신 측은 `DecodeFrame.tryDecode`로 바이트 버퍼를 해석하고, 성공 시 `FramedMessage` 객체에 타입과 요청 ID, 페이로드를 담아 반환한다 (`src/main/java/teamnova/omok/core/nio/codec/DecodeFrame.java:18`, `src/main/java/teamnova/omok/core/nio/codec/DecodeFrame.java:40`, `src/main/java/teamnova/omok/core/nio/codec/DecodeFrame.java:56`).
- 전송 측은 `EncodeFrame.encodeFrame`으로 동일한 헤더 구조를 작성해 `ByteBuffer`를 생성한다 (`src/main/java/teamnova/omok/core/nio/codec/EncodeFrame.java:7`, `src/main/java/teamnova/omok/core/nio/codec/EncodeFrame.java:13`, `src/main/java/teamnova/omok/core/nio/codec/EncodeFrame.java:18`).
- 각 메시지 타입은 `Type` 열거형에서 1바이트 값으로 정의되며, 게임 관련 명령(준비, 돌 놓기, 타임아웃 등)이 모두 포함된다 (`src/main/java/teamnova/omok/glue/handler/register/Type.java:3`, `src/main/java/teamnova/omok/glue/handler/register/Type.java:12`, `src/main/java/teamnova/omok/glue/handler/register/Type.java:25`).
- 수신된 프레임은 `Dispatcher`가 타입별 핸들러를 찾아 스레드 풀에서 실행하며, 핸들러는 세션 인증 여부를 확인한 뒤 게임 매니저 API를 호출한다 (`src/main/java/teamnova/omok/glue/handler/dispatcher/Dispatcher.java:32`, `src/main/java/teamnova/omok/glue/handler/dispatcher/Dispatcher.java:43`, `src/main/java/teamnova/omok/glue/handler/PlaceStoneHandler.java:19`).
- 예를 들어 `PlaceStoneHandler`와 `ReadyInGameSessionHandler`는 각각 좌표 문자열을 파싱하거나 단순 요청을 받아 `GameSessionManager.submitMove`와 `GameSessionManager.submitReady`를 호출한다 (`src/main/java/teamnova/omok/glue/handler/PlaceStoneHandler.java:24`, `src/main/java/teamnova/omok/glue/handler/PlaceStoneHandler.java:41`, `src/main/java/teamnova/omok/glue/handler/ReadyInGameSessionHandler.java:18`).
- 클라이언트로의 응답은 `GameSessionMessagePublisher.respondMove`, `respondReady` 등이 담당하며 JSON 문자열을 구성해 전송 큐에 넣는다 (`src/main/java/teamnova/omok/glue/game/session/services/GameSessionMessagePublisher.java:110`, `src/main/java/teamnova/omok/glue/game/session/services/GameSessionMessagePublisher.java:106`, `src/main/java/teamnova/omok/glue/message/encoder/MoveAckMessageEncoder.java:11`).
- 방송 메시지(돌 놓기, 타임아웃 등)는 `StonePlacedMessageEncoder`, `TurnTimeoutMessageEncoder`가 공통 포맷을 유지하도록 `MessageEncodingUtil.appendTurn`을 사용한다 (`src/main/java/teamnova/omok/glue/message/encoder/StonePlacedMessageEncoder.java:10`, `src/main/java/teamnova/omok/glue/message/encoder/TurnTimeoutMessageEncoder.java:10`, `src/main/java/teamnova/omok/glue/message/encoder/MessageEncodingUtil.java:24`).

## 7. 첫 번째 턴이 진행되지 않는 현상 점검 포인트
- 첫 턴 스냅샷이 null이면 `ReadyEventProcessor`가 타임아웃 스케줄을 설정하지 않으므로, 준비 이벤트에서 `turnService.start`가 정상 호출되는지 확인해야 한다 (`src/main/java/teamnova/omok/glue/game/session/services/events/ReadyEventProcessor.java:68`, `src/main/java/teamnova/omok/glue/game/session/services/TurnService.java:35`, `src/main/java/teamnova/omok/glue/game/session/services/events/ReadyEventProcessor.java:71`).
- `TurnWaitingState.handleMove`는 이미 활성화된 `TurnCycleContext`가 있으면 새 요청을 무시하므로, 이전 턴이 끝난 후 `GameSessionTurnContextService.clearTurnCycle`가 호출되었는지 체크한다 (`src/main/java/teamnova/omok/glue/game/session/states/state/TurnWaitingState.java:51`, `src/main/java/teamnova/omok/glue/game/session/states/manage/GameSessionTurnContextService.java:29`, `src/main/java/teamnova/omok/glue/game/session/states/manage/GameSessionTurnContextService.java:32`).
- `MoveEventProcessor.handleCompletion`에서 허브 상태가 `TURN_WAITING`일 때만 다음 타임아웃을 예약하므로, 상태 전이가 `MOVE_APPLYING`이나 `OUTCOME_EVALUATING`에 머무르지 않는지 디버깅 로그로 확인하는 것이 좋다 (`src/main/java/teamnova/omok/glue/game/session/services/events/MoveEventProcessor.java:63`, `src/main/java/teamnova/omok/glue/game/session/services/events/TimeoutEventProcessor.java:112`, `src/main/java/teamnova/omok/glue/game/session/states/state/MoveApplyingState.java:40`).
- 첫 턴에서 지연이 발생하면 `GameStateHub.currentType`과 `TurnSnapshot.turnEndAt`을 로깅하여 실제 상태 머신이 어느 단계에 머물러 있는지, 타임아웃이 등록되었는지를 추적한다 (`src/main/java/teamnova/omok/glue/game/session/states/GameStateHub.java:41`, `src/main/java/teamnova/omok/glue/game/session/services/TurnService.java:95`, `src/main/java/teamnova/omok/glue/game/session/services/coordinator/TurnTimeoutCoordinator.java:46`).
